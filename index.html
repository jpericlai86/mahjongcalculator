<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ éº»å°‡æ™ºèƒ½è¨ˆåˆ†å™¨</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --green: #27ae60;
            --bg: #f4f7f6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; max-width: 800px; margin: 0 auto; }
        h1, h2, h3 { color: var(--primary); text-align: center; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--accent); color: white; }
        .btn-reset { background: #95a5a6; color: white; margin-top: 30px; }
        
        /* ç©å®¶è¨­å®šå€ */
        .player-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        
        /* ç¸½åˆ†å„€è¡¨æ¿ */
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .score-box { background: #ecf0f1; padding: 10px; border-radius: 8px; }
        .score-val { font-size: 20px; font-weight: bold; display: block; margin-top: 5px; }
        .win { color: var(--green); }
        .lose { color: var(--accent); }

        /* ç´€éŒ„åˆ—è¡¨ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; }
        
        /* çµç®—å€ */
        .settlement-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 18px; display: flex; justify-content: space-between; }
        .settlement-item span { font-weight: bold; }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 600px) {
            .player-inputs { grid-template-columns: 1fr 1fr; }
            .dashboard { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <h1>ğŸ€„ éº»å°‡æ™ºèƒ½è¨ˆåˆ†å™¨</h1>

    <div class="card">
        <h3>ç©å®¶åç¨±</h3>
        <div class="player-inputs">
            <input type="text" id="p1" value="ç©å®¶ A" onchange="updateNames()">
            <input type="text" id="p2" value="ç©å®¶ B" onchange="updateNames()">
            <input type="text" id="p3" value="ç©å®¶ C" onchange="updateNames()">
            <input type="text" id="p4" value="ç©å®¶ D" onchange="updateNames()">
        </div>
    </div>

    <div class="card">
        <h3>ç•¶å‰æˆ°æ³ (ç¸½çµ)</h3>
        <div class="dashboard" id="dashboard">
            </div>
    </div>

    <div class="card">
        <h3>æ–°å¢ä¸€å±€</h3>
        <label>è´å®¶ï¼š</label>
        <select id="winner"></select>
        
        <label>é¡å‹ï¼š</label>
        <div style="display: flex; gap: 10px; margin: 10px 0;">
            <label><input type="radio" name="type" value="zimo" checked onclick="toggleLoserSelect()"> è‡ªæ‘¸ (ä¸‰å®¶è³ )</label>
            <label><input type="radio" name="type" value="chung" onclick="toggleLoserSelect()"> å‡ºè¡ (ä¸€å®¶è³ )</label>
        </div>

        <div id="loser-container" style="display: none;">
            <label>æ”¾æ§è€… (è¼¸å®¶)ï¼š</label>
            <select id="loser"></select>
        </div>

        <label>æ¯äººè³ ä»˜é‡‘é¡ / åˆ†æ•¸ï¼š</label>
        <input type="number" id="amount" placeholder="ä¾‹å¦‚ï¼š10 (ä»£è¡¨è´å®¶å¾æ¯ä½è¼¸å®¶æ”¶10å…ƒ)">
        <small style="color: #666; display: block; margin-bottom: 10px;">*è‹¥æ˜¯è‡ªæ‘¸ï¼Œè´å®¶æ”¶ 3xé‡‘é¡ï¼›è‹¥æ˜¯å‡ºè¡ï¼Œè´å®¶æ”¶ 1xé‡‘é¡ã€‚</small>

        <button class="btn-primary" onclick="addRound()">è¨˜éŒ„é€™ä¸€å±€</button>
    </div>

    <div class="card" style="border: 2px solid var(--primary);">
        <h3>ğŸ’° æœ€çµ‚çµç®— (èª°çµ¦èª°éŒ¢)</h3>
        <div id="settlement-plan">
            <p style="text-align: center; color: #7f8c8d;">æš«ç„¡æ•¸æ“š</p>
        </div>
    </div>

    <div class="card">
        <h3>å°æˆ°æ­·å²</h3>
        <table id="history-table">
            <thead>
                <tr>
                    <th>å±€æ•¸</th>
                    <th>è´å®¶</th>
                    <th>è©³æƒ…</th>
                    <th>é‡‘é¡è®Šå‹•</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button class="btn-reset" onclick="resetAll()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>

    <script>
        // åˆå§‹åŒ–ç‹€æ…‹
        let players = [
            { id: 0, name: 'ç©å®¶ A', balance: 0, wins: 0 },
            { id: 1, name: 'ç©å®¶ B', balance: 0, wins: 0 },
            { id: 2, name: 'ç©å®¶ C', balance: 0, wins: 0 },
            { id: 3, name: 'ç©å®¶ D', balance: 0, wins: 0 }
        ];
        let rounds = [];

        // å•Ÿå‹•æ™‚åŸ·è¡Œ
        window.onload = function() {
            updateNames();
            renderDashboard();
            updateSelectOptions();
        };

        // æ›´æ–°ç©å®¶åç¨±
        function updateNames() {
            players[0].name = document.getElementById('p1').value;
            players[1].name = document.getElementById('p2').value;
            players[2].name = document.getElementById('p3').value;
            players[3].name = document.getElementById('p4').value;
            renderDashboard();
            updateSelectOptions();
            calculateSettlement(); // åå­—æ”¹äº†ï¼Œçµç®—é¡¯ç¤ºä¹Ÿè¦æ”¹
        }

        // æ›´æ–°ä¸‹æ‹‰é¸å–®
        function updateSelectOptions() {
            const winnerSelect = document.getElementById('winner');
            const loserSelect = document.getElementById('loser');
            const oldWinner = winnerSelect.value;
            
            winnerSelect.innerHTML = '';
            loserSelect.innerHTML = '';

            players.forEach((p, index) => {
                let option = new Option(p.name, index);
                winnerSelect.add(option);
                loserSelect.add(option.cloneNode(true));
            });
            
            if(oldWinner) winnerSelect.value = oldWinner;
        }

        // åˆ‡æ›é¡¯ç¤ºæ”¾æ§è€…é¸å–®
        function toggleLoserSelect() {
            const type = document.querySelector('input[name="type"]:checked').value;
            document.getElementById('loser-container').style.display = type === 'chung' ? 'block' : 'none';
        }

        // æ¸²æŸ“å„€è¡¨æ¿
        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            players.forEach(p => {
                const colorClass = p.balance >= 0 ? 'win' : 'lose';
                const sign = p.balance > 0 ? '+' : '';
                dashboard.innerHTML += `
                    <div class="score-box">
                        <div>${p.name}</div>
                        <div class="score-val ${colorClass}">${sign}${p.balance}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">å‹: ${p.wins}</div>
                    </div>
                `;
            });
        }

        // æ–°å¢ä¸€å±€
        function addRound() {
            const winnerIdx = parseInt(document.getElementById('winner').value);
            const amount = parseInt(document.getElementById('amount').value);
            const type = document.querySelector('input[name="type"]:checked').value;
            
            if (!amount || amount <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }

            let roundDetail = {
                id: rounds.length + 1,
                winnerIdx: winnerIdx,
                changes: [0, 0, 0, 0],
                desc: ''
            };

            // è¨ˆç®—é‚è¼¯
            if (type === 'zimo') {
                // è‡ªæ‘¸ï¼šè´å®¶æ”¶ä¸‰å®¶
                roundDetail.desc = 'è‡ªæ‘¸';
                players.forEach((p, idx) => {
                    if (idx === winnerIdx) {
                        roundDetail.changes[idx] = amount * 3;
                    } else {
                        roundDetail.changes[idx] = -amount;
                    }
                });
            } else {
                // å‡ºè¡ï¼šæŒ‡å®šä¸€å®¶è³ 
                const loserIdx = parseInt(document.getElementById('loser').value);
                if (winnerIdx === loserIdx) { alert('è´å®¶å’Œæ”¾æ§è€…ä¸èƒ½æ˜¯åŒä¸€äºº'); return; }
                
                roundDetail.desc = `æ”¾æ§: ${players[loserIdx].name}`;
                roundDetail.changes[winnerIdx] = amount;
                roundDetail.changes[loserIdx] = -amount;
                // å…¶ä»–å…©äººä¸è®Š
            }

            // æ›´æ–°æ•¸æ“š
            rounds.push(roundDetail);
            players[winnerIdx].wins += 1;
            players.forEach((p, idx) => {
                p.balance += roundDetail.changes[idx];
            });

            // æ›´æ–° UI
            renderDashboard();
            renderHistory();
            calculateSettlement();
            
            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('amount').value = '';
        }

        // æ¸²æŸ“æ­·å²ç´€éŒ„
        function renderHistory() {
            const tbody = document.querySelector('#history-table tbody');
            tbody.innerHTML = ''; // æ¸…ç©ºèˆŠçš„
            
            // å€’åºé¡¯ç¤ºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
            [...rounds].reverse().forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>#${r.id}</td>
                    <td style="font-weight:bold; color: var(--green);">${players[r.winnerIdx].name}</td>
                    <td>${r.desc}</td>
                    <td>
                        <span style="font-size:12px">
                        ${players.map((p, i) => {
                            if(r.changes[i] === 0) return '';
                            const c = r.changes[i] > 0 ? `+${r.changes[i]}` : r.changes[i];
                            const color = r.changes[i] > 0 ? 'green' : 'red';
                            return `<span style="color:${color}">${p.name.substring(0,1)}: ${c}</span>`;
                        }).join(' ')}
                        </span>
                    </td>
                `;
            });
        }

        // *** æ ¸å¿ƒç®—æ³•ï¼šè¨ˆç®—æœ€çŸ­é‚„æ¬¾è·¯å¾‘ ***
        function calculateSettlement() {
            const container = document.getElementById('settlement-plan');
            
            // è¤‡è£½ä¸€ä»½ç•¶å‰é¤˜é¡ä¾†è¨ˆç®—ï¼Œä»¥å…å½±éŸ¿åŸå§‹æ•¸æ“š
            let debtors = [];
            let creditors = [];

            players.forEach(p => {
                if(p.balance < 0) debtors.push({ name: p.name, amount: p.balance });
                if(p.balance > 0) creditors.push({ name: p.name, amount: p.balance });
            });

            // å¦‚æœå¤§å®¶éƒ½å¹³æ‰‹
            if (debtors.length === 0 && creditors.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--green);">ç›®å‰å¸³ç›®çµæ¸…ï¼Œç„¡äººæ¬ æ¬¾ã€‚</p>';
                return;
            }

            let html = '';
            
            // æ’åºï¼šè®“æ¬ æœ€å¤šçš„äººå„ªå…ˆé‚„çµ¦è´æœ€å¤šçš„äººï¼ˆé€™æ¨£å¯ä»¥æ¸›å°‘äº¤æ˜“æ¬¡æ•¸ï¼‰
            debtors.sort((a, b) => a.amount - b.amount); // è² æ•¸å¾å°åˆ°å¤§ (-100, -50)
            creditors.sort((a, b) => b.amount - a.amount); // æ­£æ•¸å¾å¤§åˆ°å° (100, 50)

            let i = 0; // å‚µå‹™äººæŒ‡é‡
            let j = 0; // å‚µæ¬ŠäººæŒ‡é‡

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];

                // æ‰¾å‡ºé€™æ¬¡äº¤æ˜“é‡‘é¡ï¼ˆå–çµ•å°å€¼è¼ƒå°è€…ï¼‰
                // ä¾‹å¦‚ï¼šAæ¬ -50ï¼ŒBè´+30ã€‚Açµ¦B 30ï¼ŒAå‰©-20ï¼ŒBçµæ¸…ã€‚
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);

                // ç”Ÿæˆæ–‡å­—
                html += `
                    <div class="settlement-item">
                        <span>${debtor.name}</span>
                        <span style="color: #7f8c8d;"> â” çµ¦ â” </span>
                        <span>${creditor.name}</span>
                        <span style="color: var(--accent);">$${amount}</span>
                    </div>
                `;

                // æ›´æ–°é¤˜é¡
                debtor.amount += amount;
                creditor.amount -= amount;

                // æª¢æŸ¥èª°çµæ¸…äº†ï¼Œç§»å‹•æŒ‡é‡ï¼ˆç”±æ–¼æµ®é»æ•¸èª¤å·®ï¼Œç”¨ < 0.01 åˆ¤æ–·ï¼‰
                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            container.innerHTML = html;
        }

        // é‡ç½®
        function resetAll() {
            if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) return;
            rounds = [];
            players.forEach(p => { p.balance = 0; p.wins = 0; });
            renderDashboard();
            renderHistory();
            calculateSettlement();
        }
    </script>
</body>
</html>
