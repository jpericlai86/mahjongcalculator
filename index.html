<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ æ™ºèƒ½éº»å°‡è¨ˆæ•¸æ©Ÿ (è‡ªå‹•è¨ˆåƒ¹ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --green: #27ae60;
            --bg: #f0f2f5;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; max-width: 800px; margin: 0 auto; }
        h1, h2, h3 { color: var(--primary); text-align: center; margin-bottom: 15px; }
        
        /* åƒ¹ç›®è¡¨ */
        .price-table { width: 100%; font-size: 12px; margin-bottom: 15px; background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .price-table th { background: #34495e; color: white; padding: 5px; }
        .price-table td { padding: 5px; text-align: center; border-bottom: 1px solid #eee; }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        select, input { width: 100%; padding: 12px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        label { font-weight: bold; color: #34495e; font-size: 14px; display: block; margin-top: 5px; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 0 #1a252f; }
        .btn-primary:active { transform: translateY(2px); box-shadow: 0 2px 0 #1a252f; }
        .btn-reset { background: #95a5a6; color: white; margin-top: 30px; }
        
        /* ä½ˆå±€ */
        .player-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        
        /* åˆ†æ•¸é¡¯ç¤º */
        .score-box { background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .score-val { font-size: 20px; font-weight: bold; display: block; margin-top: 5px; }
        .win { color: var(--green); }
        .lose { color: var(--accent); }

        /* é¸é …æŒ‰éˆ•çµ„ */
        .radio-group { display: flex; gap: 10px; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 8px; }
        .radio-group label { margin: 0; padding: 10px; flex: 1; text-align: center; cursor: pointer; border-radius: 6px; transition: 0.2s; background: transparent; color: #7f8c8d; }
        .radio-group input { display: none; } /* éš±è—åŸç”Ÿ radio */
        .radio-group label:has(input:checked) { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; }

        /* æ­·å²è¡¨æ ¼ */
        table.history { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        table.history th, table.history td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        table.history th { background-color: #f8f9fa; color: #666; }
        
        /* çµç®—æ¨£å¼ */
        .settlement-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
        .badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 5px; }

        @media (max-width: 600px) {
            .player-inputs { grid-template-columns: 1fr 1fr; }
            .dashboard { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <h1>ğŸ€„ æ™ºèƒ½éº»å°‡è¨ˆæ•¸æ©Ÿ</h1>

    <div style="text-align: center; margin-bottom: 10px;">
        <table class="price-table">
            <thead><tr><th>ç•ªæ•¸</th><th>3ç•ª</th><th>4ç•ª</th><th>5ç•ª</th><th>6ç•ª</th><th>7ç•ª+</th></tr></thead>
            <tbody>
                <tr><td>ä¸»è³ </td><td>$20</td><td>$30</td><td>$50</td><td>$80</td><td>$100</td></tr>
                <tr><td>é–’å®¶</td><td>$10</td><td>$15</td><td>$25</td><td>$40</td><td>$50</td></tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="player-inputs">
            <input type="text" id="p1" value="ç©å®¶ A" onchange="updateUI()">
            <input type="text" id="p2" value="ç©å®¶ B" onchange="updateUI()">
            <input type="text" id="p3" value="ç©å®¶ C" onchange="updateUI()">
            <input type="text" id="p4" value="ç©å®¶ D" onchange="updateUI()">
        </div>
    </div>

    <div class="card">
        <div class="dashboard" id="dashboard"></div>
    </div>

    <div class="card" style="border-top: 5px solid var(--primary);">
        <h3>ğŸ“ è¨˜éŒ„æ–°çš„ä¸€å±€</h3>
        
        <label>æœ¬å±€è´å®¶ï¼š</label>
        <select id="winner"></select>

        <label>ç•ªæ•¸ (ç³»çµ±è‡ªå‹•è¨ˆåƒ¹)ï¼š</label>
        <select id="fan-select">
            <option value="3">3 ç•ª (ä¸»$20 / é–’$10)</option>
            <option value="4">4 ç•ª (ä¸»$30 / é–’$15)</option>
            <option value="5">5 ç•ª (ä¸»$50 / é–’$25)</option>
            <option value="6">6 ç•ª (ä¸»$80 / é–’$40)</option>
            <option value="7">7 ç•ªä»¥ä¸Š (ä¸»$100 / é–’$50)</option>
        </select>
        
        <label>è´ç‰Œæ–¹å¼ï¼š</label>
        <div class="radio-group">
            <label>
                <input type="radio" name="type" value="zimo" checked onclick="toggleInputMode()"> 
                è‡ªæ‘¸ (ä¸‰å®¶è³ )
            </label>
            <label>
                <input type="radio" name="type" value="chuchong" onclick="toggleInputMode()"> 
                å‡ºæ²– (åŒ…åº•+é–’å®¶åŠåƒ¹)
            </label>
        </div>

        <div id="chuchong-area" style="display: none;">
            <label style="color: var(--accent);">âš ï¸ èª°å‡ºæ²– (æ”¾æ§è€…)ï¼Ÿ</label>
            <select id="loser-select"></select>
        </div>

        <button class="btn-primary" onclick="addRound()">ç¢ºèªè¨˜éŒ„</button>
    </div>

    <div class="card" style="border: 2px solid var(--primary);">
        <h3>ğŸ’° æœ€çµ‚çµç®— (æœ€çŸ­é‚„æ¬¾æ–¹æ¡ˆ)</h3>
        <div id="settlement-plan">
            <p style="text-align: center; color: #7f8c8d;">æš«ç„¡æ•¸æ“š</p>
        </div>
    </div>

    <div class="card">
        <h3>å°æˆ°æ­·å²</h3>
        <table class="history" id="history-table">
            <thead>
                <tr>
                    <th width="15%">å±€æ•¸</th>
                    <th width="20%">è´å®¶</th>
                    <th width="30%">è©³æƒ…</th>
                    <th>è®Šå‹•</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button class="btn-reset" onclick="resetAll()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>

    <script>
        let players = [
            { id: 0, name: 'ç©å®¶ A', balance: 0, wins: 0 },
            { id: 1, name: 'ç©å®¶ B', balance: 0, wins: 0 },
            { id: 2, name: 'ç©å®¶ C', balance: 0, wins: 0 },
            { id: 3, name: 'ç©å®¶ D', balance: 0, wins: 0 }
        ];
        let rounds = [];

        // åƒ¹ç›®è¡¨é…ç½® (å¯åœ¨æ­¤ä¿®æ”¹åƒ¹æ ¼)
        const PRICE_TABLE = {
            3: { base: 20, half: 10 },
            4: { base: 30, half: 15 },
            5: { base: 50, half: 25 },
            6: { base: 80, half: 40 },
            7: { base: 100, half: 50 } // 7ç•ªåŠä»¥ä¸Š
        };

        window.onload = function() {
            updateUI();
            toggleInputMode();
        };

        function updateUI() {
            players[0].name = document.getElementById('p1').value;
            players[1].name = document.getElementById('p2').value;
            players[2].name = document.getElementById('p3').value;
            players[3].name = document.getElementById('p4').value;
            
            renderDashboard();
            updateSelectOptions();
            calculateSettlement();
            renderHistory();
        }

        function updateSelectOptions() {
            const winnerSelect = document.getElementById('winner');
            const loserSelect = document.getElementById('loser-select');
            
            const oldWinner = winnerSelect.value;
            const oldLoser = loserSelect.value;

            winnerSelect.innerHTML = '';
            loserSelect.innerHTML = '';

            players.forEach((p, index) => {
                let option = new Option(p.name, index);
                winnerSelect.add(option);
                loserSelect.add(option.cloneNode(true));
            });

            if (oldWinner) winnerSelect.value = oldWinner;
            if (oldLoser) loserSelect.value = oldLoser;
        }

        function toggleInputMode() {
            const type = document.querySelector('input[name="type"]:checked').value;
            const area = document.getElementById('chuchong-area');
            if (type === 'zimo') {
                area.style.display = 'none';
            } else {
                area.style.display = 'block';
            }
        }

        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            players.forEach(p => {
                const colorClass = p.balance >= 0 ? 'win' : 'lose';
                const sign = p.balance > 0 ? '+' : '';
                dashboard.innerHTML += `
                    <div class="score-box">
                        <div style="font-size:14px; color:#555;">${p.name}</div>
                        <div class="score-val ${colorClass}">${sign}${p.balance}</div>
                    </div>
                `;
            });
        }

        function addRound() {
            const winnerIdx = parseInt(document.getElementById('winner').value);
            const fanInput = parseInt(document.getElementById('fan-select').value);
            const type = document.querySelector('input[name="type"]:checked').value;
            
            // å–å¾—åƒ¹æ ¼
            const price = PRICE_TABLE[fanInput] || PRICE_TABLE[7];
            const basePay = price.base; // ä¸»è³ é‡‘é¡
            const halfPay = price.half; // é–’å®¶è³ é‡‘é¡

            let changes = [0, 0, 0, 0];
            let desc = '';
            let fanText = fanInput >= 7 ? "7ç•ª+" : `${fanInput}ç•ª`;

            if (type === 'zimo') {
                // è‡ªæ‘¸ï¼šä¸‰å®¶éƒ½ä»˜ basePay
                desc = `<span class="badge">è‡ªæ‘¸</span> ${fanText}`;
                let totalWin = 0;
                players.forEach((p, i) => {
                    if (i !== winnerIdx) {
                        changes[i] = -basePay;
                        totalWin += basePay;
                    }
                });
                changes[winnerIdx] = totalWin;

            } else {
                // å‡ºæ²–ï¼šæ”¾æ§è€…ä»˜ basePayï¼Œå…¶é¤˜å…©å®¶ä»˜ halfPay
                const loserIdx = parseInt(document.getElementById('loser-select').value);
                if (winnerIdx === loserIdx) { alert('è´å®¶å’Œæ”¾æ§è€…ä¸èƒ½æ˜¯åŒä¸€äºº'); return; }

                desc = `<span class="badge">å‡ºæ²–</span> ${fanText}`;
                let totalWin = 0;

                players.forEach((p, i) => {
                    if (i === winnerIdx) {
                        // ç¨å¾Œçµç®—
                    } else if (i === loserIdx) {
                        // æ”¾æ§è€… (å…¨é¡)
                        changes[i] = -basePay;
                        totalWin += basePay;
                    } else {
                        // é–’å®¶ (åŠåƒ¹)
                        changes[i] = -halfPay;
                        totalWin += halfPay;
                    }
                });
                changes[winnerIdx] = totalWin;
            }

            // å¯«å…¥æ•¸æ“š
            rounds.push({
                id: rounds.length + 1,
                winnerIdx: winnerIdx,
                changes: changes,
                desc: desc,
                detail: type === 'chuchong' ? `æ”¾æ§: ${players[document.getElementById('loser-select').value].name}` : ''
            });

            players[winnerIdx].wins += 1;
            players.forEach((p, i) => {
                p.balance += changes[i];
            });

            renderDashboard();
            renderHistory();
            calculateSettlement();
        }

        function renderHistory() {
            const tbody = document.querySelector('#history-table tbody');
            tbody.innerHTML = '';
            [...rounds].reverse().forEach(r => {
                const row = tbody.insertRow();
                
                // æ§‹å»ºåˆ†æ•¸è®Šå‹•å­—ä¸²
                let changeHtml = '';
                players.forEach((p, i) => {
                    if (r.changes[i] !== 0) {
                        const val = r.changes[i] > 0 ? `+${r.changes[i]}` : r.changes[i];
                        const color = r.changes[i] > 0 ? '#27ae60' : '#c0392b';
                        // åªé¡¯ç¤ºæœ‰è®Šå‹•çš„äººï¼Œç°¡åŒ–é¡¯ç¤º
                        changeHtml += `<div style="color:${color}; font-size:12px;">${p.name}: ${val}</div>`;
                    }
                });

                row.innerHTML = `
                    <td>#${r.id}</td>
                    <td style="font-weight:bold; color: var(--primary);">${players[r.winnerIdx].name}</td>
                    <td>
                        <div>${r.desc}</div>
                        <div style="font-size:11px; color:#888;">${r.detail}</div>
                    </td>
                    <td>${changeHtml}</td>
                `;
            });
        }

        function calculateSettlement() {
            const container = document.getElementById('settlement-plan');
            let debtors = [];
            let creditors = [];

            players.forEach(p => {
                if(p.balance < 0) debtors.push({ name: p.name, amount: p.balance });
                if(p.balance > 0) creditors.push({ name: p.name, amount: p.balance });
            });

            if (debtors.length === 0 && creditors.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--green);">å¸³ç›®çµæ¸…</p>';
                return;
            }

            let html = '';
            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);

                if (amount > 0) {
                    html += `
                        <div class="settlement-item">
                            <span style="color:var(--accent); font-weight:bold;">${debtor.name}</span>
                            <span style="color:#95a5a6; font-size:12px;">çµ¦</span>
                            <span style="color:var(--green); font-weight:bold;">${creditor.name}</span>
                            <span style="font-weight:bold; background:#2c3e50; color:white; padding:2px 8px; border-radius:4px;">$${amount}</span>
                        </div>
                    `;
                }

                debtor.amount += amount;
                creditor.amount -= amount;

                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }
            container.innerHTML = html;
        }

        function resetAll() {
            if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æˆ°ç¸¾å—ï¼Ÿ")) return;
            rounds = [];
            players.forEach(p => { p.balance = 0; p.wins = 0; });
            updateUI();
        }
    </script>
</body>
</html>
