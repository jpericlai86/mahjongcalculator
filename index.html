<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ éº»å°‡æ™ºèƒ½è¨ˆåˆ†å™¨ (æ–°ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --green: #27ae60;
            --bg: #f4f7f6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; max-width: 800px; margin: 0 auto; }
        h1, h2, h3 { color: var(--primary); text-align: center; margin-bottom: 10px; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        label { font-weight: bold; color: #34495e; font-size: 14px; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-reset { background: #95a5a6; color: white; margin-top: 30px; }
        
        .player-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .score-box { background: #ecf0f1; padding: 10px; border-radius: 8px; }
        .score-val { font-size: 20px; font-weight: bold; display: block; margin-top: 5px; }
        .win { color: var(--green); }
        .lose { color: var(--accent); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; }
        
        .settlement-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        .settlement-arrow { color: #95a5a6; font-size: 14px; margin: 0 10px; }

        /* è¼¸å…¥å€å¡Šåˆ‡æ›æ¨£å¼ */
        .input-group { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; }
        .radio-group { display: flex; gap: 20px; margin-bottom: 10px; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; font-size: 16px; }
        .radio-group input { width: auto; margin-right: 8px; margin-bottom: 0; }

        @media (max-width: 600px) {
            .player-inputs { grid-template-columns: 1fr 1fr; }
            .dashboard { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <h1>ğŸ€„ éº»å°‡æ™ºèƒ½è¨ˆåˆ†å™¨</h1>

    <div class="card">
        <h3>ç©å®¶åç¨±</h3>
        <div class="player-inputs">
            <input type="text" id="p1" value="ç©å®¶ A" onchange="updateNames()">
            <input type="text" id="p2" value="ç©å®¶ B" onchange="updateNames()">
            <input type="text" id="p3" value="ç©å®¶ C" onchange="updateNames()">
            <input type="text" id="p4" value="ç©å®¶ D" onchange="updateNames()">
        </div>
    </div>

    <div class="card">
        <h3>ç•¶å‰æˆ°æ³</h3>
        <div class="dashboard" id="dashboard"></div>
    </div>

    <div class="card">
        <h3>ğŸ“ è¨˜éŒ„æ–°çš„ä¸€å±€</h3>
        
        <label>æœ¬å±€è´å®¶ï¼š</label>
        <select id="winner"></select>
        
        <label>è´ç‰Œæ–¹å¼ï¼š</label>
        <div class="radio-group">
            <label><input type="radio" name="type" value="zimo" checked onclick="toggleInputMode()"> è‡ªæ‘¸ (ä¸‰å®¶è³ ä¸€æ¨£)</label>
            <label><input type="radio" name="type" value="chuchong" onclick="toggleInputMode()"> å‡ºæ²– (ä¸‰å®¶éƒ½è¦è³ )</label>
        </div>

        <div id="zimo-area" class="input-group">
            <label>æ¯äººè³ ä»˜é‡‘é¡ï¼š</label>
            <input type="number" id="amount-zimo" placeholder="ä¾‹å¦‚ï¼š20 (è´å®¶æ”¶ 20x3 = 60)">
        </div>

        <div id="chuchong-area" class="input-group" style="display: none;">
            <label style="color: var(--accent);">èª°å‡ºæ²– (æ”¾æ§è€…)ï¼Ÿ</label>
            <select id="loser-select"></select>

            <label>æ”¾æ§è€…è³ ä»˜é‡‘é¡ï¼š</label>
            <input type="number" id="amount-loser" placeholder="ä¾‹å¦‚ï¼š50 (æ¯”è¼ƒå¤š)">

            <label>å…¶é¤˜å…©å®¶ (é–’å®¶) å„è³ ä»˜é‡‘é¡ï¼š</label>
            <input type="number" id="amount-others" placeholder="ä¾‹å¦‚ï¼š10 (æ¯”è¼ƒå°‘)">
        </div>

        <button class="btn-primary" onclick="addRound()">ç¢ºèªè¨˜éŒ„</button>
    </div>

    <div class="card" style="border: 2px solid var(--primary);">
        <h3>ğŸ’° æœ€çµ‚çµç®— (æœ€çŸ­é‚„æ¬¾æ–¹æ¡ˆ)</h3>
        <div id="settlement-plan">
            <p style="text-align: center; color: #7f8c8d;">æš«ç„¡æ•¸æ“š</p>
        </div>
    </div>

    <div class="card">
        <h3>å°æˆ°æ­·å²</h3>
        <table id="history-table">
            <thead>
                <tr>
                    <th>å±€æ•¸</th>
                    <th>è´å®¶</th>
                    <th>è©³æƒ…</th>
                    <th>è®Šå‹•</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button class="btn-reset" onclick="resetAll()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>

    <script>
        let players = [
            { id: 0, name: 'ç©å®¶ A', balance: 0, wins: 0 },
            { id: 1, name: 'ç©å®¶ B', balance: 0, wins: 0 },
            { id: 2, name: 'ç©å®¶ C', balance: 0, wins: 0 },
            { id: 3, name: 'ç©å®¶ D', balance: 0, wins: 0 }
        ];
        let rounds = [];

        window.onload = function() {
            updateNames();
            toggleInputMode();
        };

        function updateNames() {
            players[0].name = document.getElementById('p1').value;
            players[1].name = document.getElementById('p2').value;
            players[2].name = document.getElementById('p3').value;
            players[3].name = document.getElementById('p4').value;
            renderDashboard();
            updateSelectOptions();
            calculateSettlement(); // åˆ·æ–°çµç®—é¡¯ç¤ºçš„åå­—
            renderHistory(); // åˆ·æ–°æ­·å²é¡¯ç¤ºçš„åå­—
        }

        function updateSelectOptions() {
            const winnerSelect = document.getElementById('winner');
            const loserSelect = document.getElementById('loser-select');
            
            // è¨˜ä½ç•¶å‰é¸æ“‡
            const oldWinner = winnerSelect.value;
            const oldLoser = loserSelect.value;

            winnerSelect.innerHTML = '';
            loserSelect.innerHTML = '';

            players.forEach((p, index) => {
                let option = new Option(p.name, index);
                winnerSelect.add(option);
                loserSelect.add(option.cloneNode(true));
            });

            if (oldWinner) winnerSelect.value = oldWinner;
            if (oldLoser) loserSelect.value = oldLoser;
        }

        // åˆ‡æ›è¼¸å…¥ä»‹é¢
        function toggleInputMode() {
            const type = document.querySelector('input[name="type"]:checked').value;
            if (type === 'zimo') {
                document.getElementById('zimo-area').style.display = 'block';
                document.getElementById('chuchong-area').style.display = 'none';
            } else {
                document.getElementById('zimo-area').style.display = 'none';
                document.getElementById('chuchong-area').style.display = 'block';
            }
        }

        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            players.forEach(p => {
                const colorClass = p.balance >= 0 ? 'win' : 'lose';
                const sign = p.balance > 0 ? '+' : '';
                dashboard.innerHTML += `
                    <div class="score-box">
                        <div>${p.name}</div>
                        <div class="score-val ${colorClass}">${sign}${p.balance}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">å‹: ${p.wins}</div>
                    </div>
                `;
            });
        }

        function addRound() {
            const winnerIdx = parseInt(document.getElementById('winner').value);
            const type = document.querySelector('input[name="type"]:checked').value;
            let changes = [0, 0, 0, 0];
            let desc = '';

            if (type === 'zimo') {
                // è‡ªæ‘¸é‚è¼¯
                const amount = parseInt(document.getElementById('amount-zimo').value);
                if (!amount || amount <= 0) { alert('è«‹è¼¸å…¥æ¯äººè³ ä»˜é‡‘é¡'); return; }
                
                desc = 'è‡ªæ‘¸';
                let totalWin = 0;
                players.forEach((p, i) => {
                    if (i !== winnerIdx) {
                        changes[i] = -amount;
                        totalWin += amount;
                    }
                });
                changes[winnerIdx] = totalWin;

            } else {
                // å‡ºæ²–é‚è¼¯ (ä¸‰å®¶è³ )
                const loserIdx = parseInt(document.getElementById('loser-select').value);
                const amountLoser = parseInt(document.getElementById('amount-loser').value);
                const amountOthers = parseInt(document.getElementById('amount-others').value);

                if (winnerIdx === loserIdx) { alert('è´å®¶å’Œå‡ºæ²–è€…ä¸èƒ½æ˜¯åŒä¸€äºº'); return; }
                if (!amountLoser || !amountOthers) { alert('è«‹è¼¸å…¥è³ ä»˜é‡‘é¡'); return; }

                desc = `å‡ºæ²–: ${players[loserIdx].name}`;
                let totalWin = 0;

                players.forEach((p, i) => {
                    if (i === winnerIdx) {
                        // è´å®¶ç¨å¾Œè™•ç†
                    } else if (i === loserIdx) {
                        changes[i] = -amountLoser;
                        totalWin += amountLoser;
                    } else {
                        // å…¶é¤˜å…©å®¶
                        changes[i] = -amountOthers;
                        totalWin += amountOthers;
                    }
                });
                changes[winnerIdx] = totalWin;
            }

            // æ›´æ–°æ•¸æ“š
            rounds.push({
                id: rounds.length + 1,
                winnerIdx: winnerIdx,
                changes: changes,
                desc: desc
            });
            players[winnerIdx].wins += 1;
            players.forEach((p, i) => {
                p.balance += changes[i];
            });

            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('amount-zimo').value = '';
            document.getElementById('amount-loser').value = '';
            document.getElementById('amount-others').value = '';

            renderDashboard();
            renderHistory();
            calculateSettlement();
        }

        function renderHistory() {
            const tbody = document.querySelector('#history-table tbody');
            tbody.innerHTML = '';
            [...rounds].reverse().forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>#${r.id}</td>
                    <td style="font-weight:bold; color: var(--green);">${players[r.winnerIdx].name}</td>
                    <td>${r.desc}</td>
                    <td>
                        <div style="font-size:12px; display:flex; flex-direction:column; gap:2px;">
                        ${players.map((p, i) => {
                            if (r.changes[i] === 0) return '';
                            const val = r.changes[i] > 0 ? `+${r.changes[i]}` : r.changes[i];
                            const color = r.changes[i] > 0 ? '#27ae60' : '#c0392b';
                            const name = p.name; 
                            return `<span style="color:${color}">${name}: ${val}</span>`;
                        }).join('')}
                        </div>
                    </td>
                `;
            });
        }

        function calculateSettlement() {
            const container = document.getElementById('settlement-plan');
            let debtors = [];
            let creditors = [];

            players.forEach(p => {
                // è¤‡è£½æ•¸å€¼ï¼Œé¿å…ä¿®æ”¹åŸæ•¸æ“š
                if(p.balance < -0.01) debtors.push({ name: p.name, amount: p.balance });
                if(p.balance > 0.01) creditors.push({ name: p.name, amount: p.balance });
            });

            if (debtors.length === 0 && creditors.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--green);">ç›®å‰ç„¡äººæ¬ æ¬¾</p>';
                return;
            }

            let html = '';
            debtors.sort((a, b) => a.amount - b.amount); // æ¬ æœ€å¤šéŒ¢çš„æ’å‰é¢
            creditors.sort((a, b) => b.amount - a.amount); // è´æœ€å¤šéŒ¢çš„æ’å‰é¢

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);

                html += `
                    <div class="settlement-item">
                        <span style="color:var(--accent); font-weight:bold;">${debtor.name}</span>
                        <span class="settlement-arrow">çµ¦</span>
                        <span style="color:var(--green); font-weight:bold;">${creditor.name}</span>
                        <span style="font-weight:bold; background:#eee; padding:2px 8px; border-radius:4px;">$${amount}</span>
                    </div>
                `;

                debtor.amount += amount;
                creditor.amount -= amount;

                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }
            container.innerHTML = html;
        }

        function resetAll() {
            if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) return;
            rounds = [];
            players.forEach(p => { p.balance = 0; p.wins = 0; });
            renderDashboard();
            renderHistory();
            calculateSettlement();
        }
    </script>
</body>
</html>
